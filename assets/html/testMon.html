<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<link rel="stylesheet" type="text/css" href="assets/css/resMon.css">
<script type="text/javascript" src="assets/lib/svg.min.js">
</script>
<script type="text/javascript" src="assets/lib/commonTools.js">
</script>
<script type="text/javascript" src="assets/lib/sprintf.js">
</script>
<script type="text/javascript" src="assets/js/bkgSVG.js">
</script>
<script type="text/javascript" src="assets/js/resCurve.js">
</script>
<script type="text/javascript" src="assets/js/scriptGen.js">
</script>
<script type="text/javascript" src="assets/js/gaugeIntf.js">
</script>
<style>
#divDataTbl
{
	position: relative;
	left: 0;
	top: 0;
	width: 45%;
	height: 52;
	overflow:hidden;
	margin: 0;
	padding: 0;
}
#divResTbl
{
	position: absolute;
	left: 45%;
	right: 0;
	top: 0;
	height: 52;
	overflow:hidden;
	margin: 0;
	padding: 0;
}
</style>
</head>
<body onUnload="top.schdUpdater=null;">

<div id="divDualLeft">
<font face="宋体" size="1">
  <div id="divDataTbl" align=center>
	<table border=1 id="schdStateTable">
	<tr>
		<td align=center><font face="黑体">监测量</font></td>
		<td align=center><font face="黑体">提交</font></td>
		<td align=center><font face="黑体">成功</font></td>
		<td align=center><font face="黑体">失败</font></td>
		<td align=center><font face="黑体">就绪</font></td>
		<td align=center><font face="黑体">阻塞</font></td>
		<td align=center><font face="黑体">运行</font></td>
		<td align=center><font face="黑体">数据</font></td>
	</tr>
	<tr id="schdStateLine">
		<td align=center><font face="黑体">监测数据</font></td>
		<td align=center id="taskAdded"></td>
		<td align=center id="taskSuccess"></td>
		<td align=center id="taskFail"></td>
		<td align=center id="taskReady"></td>
		<td align=center id="taskBlock"></td>
		<td align=center id="taskRun"></td>
		<td align=center id="nameUsed"></td>
	</tr>
	</table>
  </div>
  <div id="divResTbl"  align=center>
	<table border=0 id="resTable">
	<tr>
		<td>CPU</td><td class="gaugeTD"></td>
		<td>核</td><td class="gaugeTD"></td>
		<td>堆</td><td class="gaugeTD"></td>
		<td>任务</td><td class="gaugeTD"></td>
		<td>数据</td><td class="gaugeTD"></td>
	</tr>
	</table>
  </div>
</font>
<hr/>
<div id="divData" align=center>
<font size=3 face="黑体">数据服务器：<a id="nodeStatus"></a></font>
	<font face="宋体" size="1">
		<table border=1 id="dataTable">
		<tr>
			<td align=center><font face="黑体">视频号</font></td>
			<td align=center><font face="黑体">结果数</font></td>
			<td align=center><font face="黑体">宽度</font></td>
			<td align=center><font face="黑体">高度</font></td>
			<td align=center><font face="黑体">帧数</font></td>
			<td align=center><font face="黑体">文件名</font></td>
			<td align=center><font face="黑体">查看结果</font></td>
		</tr>
		</table>
	</font>
</div>
<hr/>
<div id="divForm">
算法：<select value="0" id="algoSel">
	<option value="0">背景减动目标检测</option>
	<option value="1">帧差法动目标检测</option>
	<option value="2" selected>双差法动目标检测</option>
	<option value="3">空间动目标检测</option>
</select> &nbsp;&nbsp;
视频：<select value="0" id="videoSel" onchange="DoSelVideo();"></select> &nbsp;&nbsp;
起始帧：<select value="10" id="startID">
	<option value="0" selected>0</option>
	<option value="10">10</option>
	<option value="20">20</option>
	<option value="40">40</option>
	<option value="80">80</option>
	<option value="120">120</option>
	<option value="160">160</option>
</select> &nbsp;&nbsp;
帧数：<select value="20" id="numFrame">
	<option value="20" selected>20</option>
	<option value="40">40</option>
	<option value="80">80</option>
	<option value="120">120</option>
	<option value="160">160</option>
	<option id="maxFrameOpt" value="320">320</option>
</select> &nbsp;&nbsp;
批次大小：<select value="5" id="batchFrame">
	<option value="1">1</option>
	<option value="2">1</option>
	<option value="5" selected>5</option>
	<option value="8">8</option>
	<option value="10">10</option>
</select>帧/批 &nbsp;&nbsp;
<input type="button" id="beginSubmit" value="开始" onClick="OnSubmitTask();"/>
</div>
<div id="divSubmit"></div>
<hr/>
<font color="red"><div id="divMsg"></div></font>
</div>

<div id="divDualRight">
<font color="red"><div id="divScript"></div></font>
</div>
<script type="text/javascript">
//------------------------------------------------------------------
var submitAlgo=-1,submitVideo=-1,submitStart,submitNum,submitBatch,submitCnt=0;
var dataStore;
//------------------------------------------------------------------
function DoSelVideo()
{
	videoID = parseInt(videoSel.value);
	maxFrameOpt.innerHTML = maxFrameOpt.value = dataStore[videoID].nFrame;
	maxFrameOpt.selected = true;
}
//------------------------------------------------------------------
function EndSubmit()
{
	submitCnt   = 0;
	submitVideo = -1;
	divForm.style.display   = "block";
	divSubmit.style.display = "none";
}
//------------------------------------------------------------------
function OnSubmitRet(info,code)
{
	divMsg.innerHTML = "<pre>"+info+"</pre>";
	if(code!=0)
		EndSubmit();
}
//------------------------------------------------------------------
function OnSubmitNetError()
{
	divMsg.innerHTML = "提交任务失败";
	EndSubmit();
}
//------------------------------------------------------------------
function SubmitBatch(isFirst)
{
	var params = "/script/Run";
	var nFrame = 5;
	if(nFrame>submitNum)
		nFrame = submitNum;
	
	var script = GenScirpt(submitVideo,submitStart,nFrame,top.jsSvrIP,top.jsDataDlPort,top.jsResultPort,scriptTmpls[submitAlgo],isFirst,(nFrame>=submitNum));
	
	submitNum -= submitBatch;
	submitCnt ++;
	var showResult = "assets/html/objMon.html#videoID="+submitVideo+
		"&frameID="+submitStart+"&w="+dataStore[submitVideo].w+
		"&h="+dataStore[submitVideo].h;
		
	arrResult[submitVideo].href = showResult;
	
	var msg = "提交：次数="+submitCnt+"&nbsp;&nbsp;视频="+submitVideo+"&nbsp;&nbsp;起始帧="+submitStart+"&nbsp;&nbsp;帧数="+submitBatch+"&nbsp;&nbsp;剩余="+submitNum;
	msg += "<a target='resultTab' href='"+showResult+"'>查看结果</a>";
	divSubmit.innerHTML = msg;

	submitStart += submitBatch;

	divScript.innerHTML = "<pre>"+script+"</pre>";

	const fetchOpt = 
	{
		method: 'POST',
		body: script
	};
	
	fetch(params,fetchOpt)
		.then(res=>res.json())
		.then(infoData=>OnSubmitRet(infoData.info,infoData.result))
		.catch(err=>OnSubmitNetError());
}
//------------------------------------------------------------------
function OnSubmitTask()
{
	if(submitVideo>=0)
	{
		alert("前一个测试尚未完成，请等待测试完成再提交新任务！");
		return;
	}
	
	var sData     = top.curSchdStat;
	var queueTask = sData.taskReady+sData.taskBlock;

	if(sData>0)
	{
		alert("前一个测试尚未完成，无法提交新任务！");
		return;
	}

	divForm.style.display   = "none";
	divSubmit.style.display = "block";
	
	submitAlgo  = parseInt(algoSel.value);
	submitVideo = parseInt(videoSel.value);
	submitStart = parseInt(startID.value);
	submitNum   = parseInt(numFrame.value);
	submitBatch = parseInt(batchFrame.value);
	
	SubmitBatch(true);
}
//------------------------------------------------------------------
function GenDataTd(trLine, val)
{
	var tdRef = document.createElement('td');
	tdRef.innerHTML = val;
	trLine.appendChild(tdRef);
	
	return tdRef;
}
//------------------------------------------------------------------
var arrUpTd   = new Array();
var arrResult = new Array();
//------------------------------------------------------------------
function InitData(data)
{
	dataStore = data;
	for(var i=0;i<data.length;i++)
	{
		var trLine = document.createElement('tr');
		dataTable.appendChild(trLine);
		
		GenDataTd(trLine,i);

		var td = GenDataTd(trLine,data[i].uploadResult);
		arrUpTd.push(td);

		GenDataTd(trLine,data[i].w);
		GenDataTd(trLine,data[i].h);
		GenDataTd(trLine,data[i].nFrame);
		GenDataTd(trLine,data[i].file);
		
		var tdC = GenDataTd(trLine,"");
		var aC  = document.createElement('a');
		
		aC.target = "resultTab";
		aC.href   = "assets/html/objMon.html#videoID="+i+
			"&frameID="+10+"&w="+dataStore[i].w+
			"&h="+dataStore[i].h;
		aC.innerHTML = "查看结果";
		
		arrResult.push(aC);
		
		tdC.appendChild(aC);

		var opt = document.createElement('option');
		opt.value = i;
		opt.innerHTML = i;
		videoSel.appendChild(opt);
		if(i==1)
			opt.selected = true;
	}
	
	top.ColorTableRows(dataTable,top.defColorPlan);
	top.ColorTableRows(schdStateTable,top.defColorPlan);
	
	DoSelVideo();
}
//------------------------------------------------------------------
var arrResTd  = resTable.getElementsByClassName("gaugeTD");
var arrResSVG = new Array(arrResTd.length);
for(var i=0;i<arrResTd.length;i++)
{
	arrResSVG[i] = new TGaugeIntf(arrResTd[i],48,48);
}
//------------------------------------------------------------------
function OnNetError()
{
	nodeStatus.innerHTML = "<font color=red>停机</font>";
}
//------------------------------------------------------------------
fetch(top.jsDataListURL)
	.then(res=>res.json())
	.then(dataList=>InitData(dataList.data))
	.catch(err=>OnNetError());
//------------------------------------------------------------------
function UpdateResultData(data)
{
	for(var i=0;i<data.length;i++)
	{
		arrUpTd[i].innerHTML = data[i].uploadResult;
	}

	nodeStatus.innerHTML = "<font color=green>运行</font>";	
}
//------------------------------------------------------------------
function UpdateSubmitData()
{
	for(var i=0;i<arrResSVG.length;i++)
	{
		arrResSVG[i].SetValue(top.resRatio[i]*100);
	}

	var tds   = schdStateLine.getElementsByTagName("td");
	var sData = top.curSchdStat;
	var nVal  = tds.length;
	
	for(var i=1;i<nVal;i++)
	{
		tds[i].innerHTML = sData[tds[i].id];
	}
	
	var queueTask = sData.taskReady+sData.taskBlock;
	
	if((submitCnt>0)&&(submitNum>0))
	{
		if(queueTask<10)
			SubmitBatch(false);
	}
	else if( (queueTask==0) && (sData.taskRun==0) )
	{
		if(submitVideo>=0)
			EndSubmit();
	}
}
//------------------------------------------------------------------
function OnUpdateResult()
{
	fetch(top.jsDataListURL)
		.then(res=>res.json())
		.then(dataList=>UpdateResultData(dataList.data))
		.catch(err=>OnNetError());
}
//------------------------------------------------------------------
OnUpdateResult();
top.schdUpdater = UpdateSubmitData;
var timer = setInterval(OnUpdateResult,top.updateInterval);
//------------------------------------------------------------------
</script>

</body>
</html>
